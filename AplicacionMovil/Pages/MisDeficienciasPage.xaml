<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AplicacionMovil.Pages.MisDeficienciasPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Title="">

    <Grid RowDefinitions="Auto,*">

        <!-- Barra fija -->
        <Grid Grid.Row="0"
              RowDefinitions="Auto,Auto"
              ColumnDefinitions="Auto,*,Auto,Auto"
              Padding="12,10"
              BackgroundColor="#E5E7EB">

            <Button Grid.Row="0" Grid.Column="0"
                    Text="Retornar"
                    FontSize="16"
                    BackgroundColor="#16A34A"
                    TextColor="White"
                    CornerRadius="10"
                    Padding="10,4"
                    Clicked="OnVolverInicioClicked" />

            <Label Grid.Row="0" Grid.Column="1"
                   Text="Mis Deficiencias"
                   FontSize="16"
                   FontAttributes="Bold"
                   TextColor="#111827"
                   VerticalOptions="Center"
                   Margin="10,0,0,0" />

            <Button Grid.Row="0" Grid.Column="2"
                    Text="Historial"
                    FontSize="12"
                    BackgroundColor="#2563EB"
                    TextColor="White"
                    CornerRadius="10"
                    Padding="10,2"
                    Margin="6,0,0,0"
                    Clicked="OnHistorialClicked" />

            <Button Grid.Row="0" Grid.Column="3"
                    Text="Salir"
                    FontSize="12"
                    BackgroundColor="#DC2626"
                    TextColor="White"
                    CornerRadius="10"
                    Padding="10,2"
                    Margin="6,0,0,0"
                    Clicked="OnLogoutClicked" />

            <Button Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="4"
                    Text="Ver mapa de Deficiencias"
                    BackgroundColor="#2563EB"
                    TextColor="White"
                    CornerRadius="12"
                    HeightRequest="44"
                    Margin="0,8,0,0"
                    Clicked="OnVerMapa" />
        </Grid>

        <!-- Contenido -->
        <RefreshView Grid.Row="1"
                     x:Name="refreshView"
                     RefreshColor="#2563EB"
                     Refreshing="OnRefresh">

            <ScrollView>
                <VerticalStackLayout Padding="16" Spacing="12">

                    <Label x:Name="lblEstado"
                           Text="Cargando..."
                           FontSize="12"
                           TextColor="#6B7280"
                           Margin="2,0,2,6" />

                    <!-- Lista -->
                    <VerticalStackLayout Spacing="10"
                     BindableLayout.ItemsSource="{Binding Deficiencias}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate>
                                <Frame Padding="14"
                                       CornerRadius="16"
                                       HasShadow="False"
                                       BorderColor="#E5E7EB"
                                       BackgroundColor="White">

                                    <VerticalStackLayout Spacing="6">

                                        <!-- Código de deficiencia (destacado) -->
                                        <Label Text="{Binding CodigoDeficiencia}"
                                               FontAttributes="Bold"
                                               FontSize="18"
                                               TextColor="#111827"
                                               Margin="0,0,0,4" />

                                        <!-- Grid de información principal -->
                                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8" RowSpacing="4">

                                            <!-- Unidad Zonal -->
                                            <Label Grid.Row="0" Grid.Column="0" 
                                                   Text="Zonal:" 
                                                   FontAttributes="Bold"
                                                   FontSize="13"
                                                   TextColor="#6B7280" />
                                            <Label Grid.Row="0" Grid.Column="1" 
                                                   Text="{Binding UnidadZonal}" 
                                                   FontSize="13"
                                                   TextColor="#111827" />

                                            <!-- Alimentador -->
                                            <Label Grid.Row="1" Grid.Column="0" 
                                                   Text="Alimentador:" 
                                                   FontAttributes="Bold"
                                                   FontSize="13"
                                                   TextColor="#6B7280" />
                                            <Label Grid.Row="1" Grid.Column="1" 
                                                   Text="{Binding Alimentador}" 
                                                   FontSize="13"
                                                   TextColor="#111827" />

                                            <!-- Tipificación -->
                                            <Label Grid.Row="2" Grid.Column="0" 
                                                   Text="Tipificación:" 
                                                   FontAttributes="Bold"
                                                   FontSize="13"
                                                   TextColor="#6B7280" />
                                            <Label Grid.Row="2" Grid.Column="1" 
                                                   Text="{Binding CodigoTipificacion}" 
                                                   FontSize="13"
                                                   TextColor="#111827" />

                                            <!-- Prioridad -->
                                            <Label Grid.Row="3" Grid.Column="0" 
                                                   Text="Prioridad:" 
                                                   FontAttributes="Bold"
                                                   FontSize="13"
                                                   TextColor="#6B7280" />
                                            <Label Grid.Row="3" Grid.Column="1" 
                                                   Text="{Binding Prioridad}" 
                                                   FontSize="13"
                                                   TextColor="#DC2626"
                                                   FontAttributes="Bold" />

                                            <!-- Estado -->
                                            <Label Grid.Row="4" Grid.Column="0" 
                                                   Text="Estado:" 
                                                   FontAttributes="Bold"
                                                   FontSize="13"
                                                   TextColor="#6B7280" />
                                            <Label Grid.Row="4" Grid.Column="1" 
                                                   Text="{Binding EstadoSubsanacion}" 
                                                   FontSize="13"
                                                   TextColor="#2563EB"
                                                   FontAttributes="Bold" />

                                            <!-- Fecha Denuncia -->
                                            <Label Grid.Row="5" Grid.Column="0" 
                                                   Text="F. Denuncia:" 
                                                   FontAttributes="Bold"
                                                   FontSize="13"
                                                   TextColor="#6B7280" />
                                            <Label Grid.Row="5" Grid.Column="1" 
                                                   Text="{Binding FechaDenuncia, StringFormat='{0:dd/MM/yyyy HH:mm}'}" 
                                                   FontSize="13"
                                                   TextColor="#111827" />

                                            <!-- Coordenadas (si existen) -->
                                            <Label Grid.Row="6" Grid.Column="0" 
                                                   Text="GPS:" 
                                                   FontAttributes="Bold"
                                                   FontSize="13"
                                                   TextColor="#6B7280" 
                                                   IsVisible="{Binding Latitud, Converter={StaticResource IsNotNullConverter}}" />
                                            <Label Grid.Row="6" Grid.Column="1" 
                                                   FontSize="12"
                                                   TextColor="#059669"
                                                   IsVisible="{Binding Latitud, Converter={StaticResource IsNotNullConverter}}">
                                                <Label.Text>
                                                    <MultiBinding StringFormat="{}{0:F6}, {1:F6}">
                                                        <Binding Path="Latitud" />
                                                        <Binding Path="Longitud" />
                                                    </MultiBinding>
                                                </Label.Text>
                                            </Label>

                                        </Grid>

                                        <!-- Botones de acción -->
                                        <HorizontalStackLayout Spacing="10" Margin="0,12,0,0">
                                            <Button Text="Ruta"
                                                    BackgroundColor="#4F46E5"
                                                    TextColor="White"
                                                    CornerRadius="10"
                                                    FontSize="13"
                                                    Padding="16,8"
                                                    HorizontalOptions="FillAndExpand"
                                                    Clicked="OnRutaClicked" />

                                            <Button Text="Mapa"
                                                    BackgroundColor="#059669"
                                                    TextColor="White"
                                                    CornerRadius="10"
                                                    FontSize="13"
                                                    Padding="16,8"
                                                    HorizontalOptions="FillAndExpand"
                                                    Clicked="OnMapaItemClicked" />
                                        </HorizontalStackLayout>

                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>

    </Grid>
</ContentPage>
